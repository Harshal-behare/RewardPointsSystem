<div class="dashboard-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Admin Dashboard</h1>
    <p class="subtitle">System overview and quick actions</p>
  </div>

  <!-- Section 1: System Overview (5 KPI Cards) -->
  <section class="kpi-section">
    @for (kpi of kpiData(); track kpi.label) {
      <app-kpi-card
        [icon]="kpi.icon"
        [label]="kpi.label"
        [value]="kpi.value"
        [trend]="kpi.trend"
        (click)="navigateToPage(kpi.route)"
        style="cursor: pointer;"
        title="Click to view {{ kpi.label }}"
      ></app-kpi-card>
    }
  </section>

  <!-- Monthly Budget Section -->
  <section class="budget-section">
    <app-card title="Monthly Points Budget" subtitle="Track your points awarding for this month">
      @if (adminBudget()) {
        <div class="budget-overview" [class]="budgetUsageClass()">
          <div class="budget-stats">
            <div class="budget-stat-item">
              <span class="stat-label">Budget Limit</span>
              <span class="stat-value">{{ formatNumber(adminBudget()!.budgetLimit) }} pts</span>
            </div>
            <div class="budget-stat-item">
              <span class="stat-label">Points Awarded</span>
              <span class="stat-value">{{ formatNumber(adminBudget()!.pointsAwarded) }} pts</span>
            </div>
            <div class="budget-stat-item">
              <span class="stat-label">Remaining</span>
              <span class="stat-value" [class.negative]="adminBudget()!.remainingBudget < 0">
                {{ formatNumber(adminBudget()!.remainingBudget) }} pts
              </span>
            </div>
          </div>

          <div class="budget-progress-container">
            <div class="budget-progress-header">
              <span class="progress-label">{{ adminBudget()!.monthYearDisplay }}</span>
              <span class="progress-percentage" [class.over-budget]="adminBudget()!.isOverBudget" [class.warning]="adminBudget()!.isWarningZone">
                {{ adminBudget()!.usagePercentage | number:'1.0-1' }}% used
              </span>
            </div>
            <div class="budget-progress-bar">
              <div 
                class="budget-progress-fill" 
                [class.over-budget]="adminBudget()!.isOverBudget"
                [class.warning]="adminBudget()!.isWarningZone"
                [style.width.%]="adminBudget()!.usagePercentage > 100 ? 100 : adminBudget()!.usagePercentage">
              </div>
              @if (adminBudget()!.warningThreshold < 100) {
                <div class="warning-threshold-marker" [style.left.%]="adminBudget()!.warningThreshold"></div>
              }
            </div>
          </div>

          <div class="budget-info">
            @if (adminBudget()!.isOverBudget) {
              <div class="budget-alert danger">
                <app-icon name="warning" [size]="16"></app-icon>
                <span>You have exceeded your monthly budget by {{ formatNumber(adminBudget()!.pointsAwarded - adminBudget()!.budgetLimit) }} points</span>
              </div>
            } @else if (adminBudget()!.isWarningZone) {
              <div class="budget-alert warning">
                <app-icon name="warning" [size]="16"></app-icon>
                <span>You've used {{ adminBudget()!.usagePercentage | number:'1.0-1' }}% of your budget. {{ formatNumber(adminBudget()!.remainingBudget) }} points remaining.</span>
              </div>
            }
            <div class="budget-type">
              <app-badge [variant]="adminBudget()!.isHardLimit ? 'danger' : 'secondary'" size="sm">
                {{ adminBudget()!.isHardLimit ? 'Hard Limit' : 'Soft Limit' }}
              </app-badge>
              <span class="type-description">
                {{ adminBudget()!.isHardLimit ? 'Points awarding blocked when exceeded' : 'Warning only when exceeded' }}
              </span>
            </div>
          </div>

          <div class="budget-actions">
            <app-button variant="secondary" size="sm" (clicked)="openBudgetModal('edit')">
              <app-icon name="settings" [size]="14"></app-icon>
              Edit Budget
            </app-button>
          </div>
        </div>
      } @else {
        <div class="no-budget-state">
          <div class="no-budget-icon">
            <app-icon name="coins" [size]="48"></app-icon>
          </div>
          <h3>No Budget Set</h3>
          <p>Set a monthly points budget to track and control your points awarding.</p>
          <app-button (clicked)="openBudgetModal('create')">
            <app-icon name="plus" [size]="16"></app-icon>
            Set Monthly Budget
          </app-button>
        </div>
      }
    </app-card>
  </section>

  <!-- Inventory Alerts (Full Width) -->
  <section class="inventory-section">
    <app-card title="Inventory Alerts" subtitle="Low stock products requiring attention">
      @if (inventoryAlerts().length > 0) {
        <div class="inventory-alerts-list">
          @for (alert of inventoryAlerts(); track alert.productId) {
            <div class="inventory-alert-item">
              <div class="alert-icon" [class.critical]="alert.currentStock === 0">
                <app-icon name="warning" [size]="18"></app-icon>
              </div>
              <div class="alert-content">
                <div class="alert-product">{{ alert.productName }}</div>
                <div class="alert-status">
                  @if (alert.currentStock === 0) {
                    <app-badge variant="danger" size="sm">Out of Stock</app-badge>
                  } @else {
                    <app-badge variant="warning" size="sm">Low Stock ({{ alert.currentStock }} units)</app-badge>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <app-icon name="check-circle" [size]="40"></app-icon>
          <p>All products have sufficient stock</p>
        </div>
      }
    </app-card>
  </section>

  <!-- Charts Section -->
  <div class="grid-2-col charts-section">
    <app-card title="Redemption Status Distribution" class="chart-card clickable-card" (click)="navigateToPage('/admin/redemptions')">
      <div class="chart-container">
        <apx-chart
          [series]="redemptionChartOptions().series"
          [chart]="redemptionChartOptions().chart"
          [labels]="redemptionChartOptions().labels"
          [colors]="redemptionChartOptions().colors"
          [legend]="redemptionChartOptions().legend"
          [responsive]="redemptionChartOptions().responsive"
        ></apx-chart>
      </div>
    </app-card>

    <app-card title="Event Status Distribution" class="chart-card clickable-card" (click)="navigateToPage('/admin/events')">
      <div class="chart-container">
        <apx-chart
          [series]="eventChartOptions().series"
          [chart]="eventChartOptions().chart"
          [labels]="eventChartOptions().labels"
          [colors]="eventChartOptions().colors"
          [legend]="eventChartOptions().legend"
          [responsive]="eventChartOptions().responsive"
        ></apx-chart>
      </div>
    </app-card>
  </div>

  <!-- Quick Actions Section -->
  <app-card title="Quick Actions" class="quick-actions-card">
    <div class="quick-actions-grid">
      <button class="quick-action-btn redemptions-btn" (click)="navigateToPage('/admin/redemptions')">
        <span class="action-icon"><app-icon name="shopping-cart" [size]="24"></app-icon></span>
        <div class="action-content">
          <h3>Redemptions</h3>
          <p>Process pending redemptions</p>
        </div>
      </button>

      <button class="quick-action-btn users-btn" (click)="navigateToPage('/admin/users')">
        <span class="action-icon"><app-icon name="users" [size]="24"></app-icon></span>
        <div class="action-content">
          <h3>Manage Users</h3>
          <p>View and manage users</p>
        </div>
      </button>

      <button class="quick-action-btn event-btn" (click)="openEventModal()">
        <span class="action-icon"><app-icon name="calendar" [size]="24"></app-icon></span>
        <div class="action-content">
          <h3>Create Event</h3>
          <p>Add a new reward event</p>
        </div>
      </button>

      <button class="quick-action-btn product-btn" (click)="openProductModal()">
        <span class="action-icon"><app-icon name="gift" [size]="24"></app-icon></span>
        <div class="action-content">
          <h3>Add Product</h3>
          <p>Add new product to catalog</p>
        </div>
      </button>
    </div>
  </app-card>
</div>

<!-- Create Event Modal -->
@if (showEventModal()) {
  <div class="modal-overlay" (click)="closeEventModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create New Event</h3>
      </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        @if (eventModalValidationErrors().length > 0) {
          <div class="error-list">
            @for (error of eventModalValidationErrors(); track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }

        <div class="form-group">
          <label for="eventName">Event Name *</label>
          <input
            id="eventName"
            type="text"
            [(ngModel)]="newEvent.name"
            name="name"
            placeholder="Enter event name"
            required
            minlength="3"
            maxlength="200"
          />
          <small class="form-hint">3-200 characters required</small>
        </div>

        <div class="form-group">
          <label for="eventDescription">Description</label>
          <textarea
            id="eventDescription"
            [(ngModel)]="newEvent.description"
            name="description"
            placeholder="Enter event description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventDate">Event Start Date *</label>
            <input
              id="eventDate"
              type="date"
              [(ngModel)]="newEvent.eventDate"
              name="eventDate"
              required
              placeholder="YYYY-MM-DD"
            />
            <small class="form-hint">Must be a future date</small>
          </div>

          <div class="form-group">
            <label for="eventEndDate">Event End Date</label>
            <input
              id="eventEndDate"
              type="date"
              [(ngModel)]="newEvent.eventEndDate"
              name="eventEndDate"
              placeholder="YYYY-MM-DD"
            />
            <small class="form-hint">Leave empty for single-day events</small>
          </div>
        </div>

        <div class="form-group">
          <label for="maxParticipants">Max Participants</label>
          <input
            id="maxParticipants"
            type="number"
            [(ngModel)]="newEvent.maxParticipants"
            name="maxParticipants"
            placeholder="0 (unlimited)"
            min="0"
          />
          <small class="form-hint">Leave as 0 for unlimited participants</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pointsPool">Points Pool *</label>
            <input
              id="pointsPool"
              type="number"
              [(ngModel)]="newEvent.pointsPool"
              name="pointsPool"
              placeholder="0"
              required
              min="1"
              max="1000000"
            />
            <small class="form-hint">Must be greater than 0, max 1,000,000</small>
          </div>
        </div>

        <!-- Prize Distribution Section -->
        <div class="form-section">
          <h4 class="form-section-title"><app-icon name="trophy" [size]="18"></app-icon> Prize Distribution (Optional)</h4>
          <p class="form-section-hint">Set point rewards for top performers</p>

          <div class="form-row prize-row">
            <div class="form-group prize-input first-place">
              <label for="firstPlacePoints">ü•á 1st Place</label>
              <input
                id="firstPlacePoints"
                type="number"
                [(ngModel)]="newEvent.firstPlacePoints"
                name="firstPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>

            <div class="form-group prize-input second-place">
              <label for="secondPlacePoints">ü•à 2nd Place</label>
              <input
                id="secondPlacePoints"
                type="number"
                [(ngModel)]="newEvent.secondPlacePoints"
                name="secondPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>

            <div class="form-group prize-input third-place">
              <label for="thirdPlacePoints">ü•â 3rd Place</label>
              <input
                id="thirdPlacePoints"
                type="number"
                [(ngModel)]="newEvent.thirdPlacePoints"
                name="thirdPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>
          </div>

          <!-- Remaining Pool Display -->
          <div class="prize-summary" [class.warning]="getRemainingPool() < 0" [class.valid]="getRemainingPool() >= 0 && getTotalPrizes() > 0">
            <div class="pool-info">
              <span class="pool-label">Remaining Pool:</span>
              <span class="pool-value" [class.negative]="getRemainingPool() < 0">{{ getRemainingPool() }} pts</span>
            </div>
            @if (getTotalPrizes() > 0) {
              <small class="pool-detail">Assigned: {{ getTotalPrizes() }} / {{ newEvent.pointsPool || 0 }} pts</small>
            }
            @if (getRemainingPool() < 0) {
              <small class="pool-error">‚ö†Ô∏è Prize total exceeds points pool!</small>
            }
          </div>
        </div>

        <!-- Registration Period Section -->
        <div class="form-section">
          <h4 class="form-section-title"><app-icon name="calendar" [size]="18"></app-icon> Registration Period (Optional)</h4>

          <div class="form-row">
            <div class="form-group">
              <label for="registrationStartDate">Registration Opens</label>
              <input
                id="registrationStartDate"
                type="date"
                [(ngModel)]="newEvent.registrationStartDate"
                name="registrationStartDate"
                placeholder="YYYY-MM-DD"
              />
            </div>

            <div class="form-group">
              <label for="registrationEndDate">Registration Closes</label>
              <input
                id="registrationEndDate"
                type="date"
                [(ngModel)]="newEvent.registrationEndDate"
                name="registrationEndDate"
                placeholder="YYYY-MM-DD"
              />
            </div>
          </div>
        </div>

        <!-- Location Section -->
        <div class="form-section">
          <h4 class="form-section-title"><app-icon name="location" [size]="18"></app-icon> Event Location (Optional)</h4>

          <div class="form-group">
            <label for="location">Physical Location</label>
            <input
              id="location"
              type="text"
              [(ngModel)]="newEvent.location"
              name="location"
              placeholder="e.g., Conference Room A, Building 1"
            />
          </div>

          <div class="form-group">
            <label for="virtualLink">Virtual Meeting Link</label>
            <input
              id="virtualLink"
              type="url"
              [(ngModel)]="newEvent.virtualLink"
              name="virtualLink"
              placeholder="https://zoom.us/j/meeting-id"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">Event Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="newEvent.imageUrl"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
          />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeEventModal()">
        Cancel
      </app-button>
      <app-button (clicked)="createEvent()">
        Create Event
      </app-button>
    </div>
    </div>
  </div>
}

<!-- Create Product Modal -->
@if (showProductModal()) {
  <div class="modal-overlay" (click)="closeProductModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add New Product</h3>
      </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        @if (productModalValidationErrors().length > 0) {
          <div class="error-list">
            @for (error of productModalValidationErrors(); track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }

        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input
            id="productName"
            type="text"
            [(ngModel)]="newProduct.name"
            name="name"
            placeholder="Enter product name"
            required
            minlength="2"
            maxlength="200"
          />
          <small class="form-hint">2-200 characters required</small>
        </div>

        <div class="form-group">
          <label for="productDescription">Description</label>
          <textarea
            id="productDescription"
            [(ngModel)]="newProduct.description"
            name="description"
            placeholder="Enter product description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select
              id="category"
              [(ngModel)]="newProduct.categoryId"
              name="categoryId"
              required
            >
              <option value="">Select a category</option>
              @for (cat of categories(); track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="pointsPrice">Points Price *</label>
            <input
              id="pointsPrice"
              type="number"
              [(ngModel)]="newProduct.pointsPrice"
              name="pointsPrice"
              placeholder="0"
              required
              min="1"
            />
            <small class="form-hint">Must be greater than 0</small>
          </div>
        </div>

        <div class="form-group">
          <label for="stock">Stock Quantity *</label>
          <input
            id="stock"
            type="number"
            [(ngModel)]="newProduct.stock"
            name="stock"
            placeholder="0"
            required
            min="0"
          />
          <small class="form-hint">Cannot be negative</small>
        </div>

        <div class="form-group">
          <label for="imageUrl">Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="newProduct.imageUrl"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
            maxlength="500"
          />
          <small class="form-hint">Must be a valid URL (http:// or https://), max 500 characters</small>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeProductModal()">
        Cancel
      </app-button>
      <app-button (clicked)="createProduct()">
        Add Product
      </app-button>
    </div>
    </div>
  </div>
}

<!-- Budget Settings Modal -->
@if (showBudgetModal()) {
  <div class="modal-overlay" (click)="closeBudgetModal()">
    <div class="modal-content budget-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ budgetModalMode() === 'create' ? 'Set Monthly Budget' : 'Edit Monthly Budget' }}</h3>
      </div>

      <div class="modal-body">
        <!-- Validation Errors -->
        @if (budgetValidationErrors().length > 0) {
          <div class="error-list">
            @for (error of budgetValidationErrors(); track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }

        <div class="budget-form-info">
          <app-icon name="info" [size]="18"></app-icon>
          <p>Set a monthly points budget to track how many points you award. The budget resets on the 1st of each month.</p>
        </div>

        <div class="form-group">
          <label for="budgetLimit">Monthly Budget Limit *</label>
          <input
            id="budgetLimit"
            type="number"
            [ngModel]="budgetForm().budgetLimit"
            (ngModelChange)="updateBudgetFormField('budgetLimit', $event)"
            name="budgetLimit"
            placeholder="50000"
            required
            min="1"
            max="10000000"
          />
          <small class="form-hint">Maximum points you can award this month (1 - 10,000,000)</small>
        </div>

        <div class="form-group">
          <label for="warningThreshold">Warning Threshold (%)</label>
          <input
            id="warningThreshold"
            type="number"
            [ngModel]="budgetForm().warningThreshold"
            (ngModelChange)="updateBudgetFormField('warningThreshold', $event)"
            name="warningThreshold"
            placeholder="80"
            min="0"
            max="100"
          />
          <small class="form-hint">You'll see a warning when usage reaches this percentage (default: 80%)</small>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [ngModel]="budgetForm().isHardLimit"
              (ngModelChange)="updateBudgetFormField('isHardLimit', $event)"
              name="isHardLimit"
            />
            <span class="checkbox-text">
              <strong>Hard Limit</strong>
              <small>Block awarding when budget is exceeded (otherwise only shows warning)</small>
            </span>
          </label>
        </div>

        @if (adminBudget() && budgetModalMode() === 'edit') {
          <div class="current-usage-info">
            <h4>Current Month Usage</h4>
            <div class="usage-details">
              <span>Points Awarded: <strong>{{ formatNumber(adminBudget()!.pointsAwarded) }}</strong></span>
              <span>Remaining: <strong [class.negative]="adminBudget()!.remainingBudget < 0">{{ formatNumber(adminBudget()!.remainingBudget) }}</strong></span>
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <app-button variant="secondary" (clicked)="closeBudgetModal()">
          Cancel
        </app-button>
        <app-button (clicked)="saveBudget()">
          {{ budgetModalMode() === 'create' ? 'Set Budget' : 'Update Budget' }}
        </app-button>
      </div>
    </div>
  </div>
}
