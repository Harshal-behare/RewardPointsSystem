<div class="users-container">
  <!-- Quick Actions Bar -->
  <div class="quick-actions-bar">
    <button class="quick-action-btn primary" (click)="openCreateModal()">
      <span class="action-icon">‚ûï</span>
      <span>Add New User</span>
    </button>
    <button class="quick-action-btn secondary" (click)="loadUsers()">
      <span class="action-icon">üîÑ</span>
      <span>Refresh</span>
    </button>
  </div>

  <app-card>
    <!-- Header -->
    <div header class="users-header">
      <div>
        <h2>User Management</h2>
        <p class="subtitle">Manage system users and their roles</p>
      </div>
      <app-button (clicked)="openCreateModal()">
        ‚ûï Add User
      </app-button>
    </div>

    <!-- Users Table -->
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Points Balance</th>
            <th>Created Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
            <tr [class.inactive-row]="user.status === 'Inactive'">
              <td>
                <div class="user-name">
                  <div class="user-avatar">
                    {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                  </div>
                  <strong>{{ user.firstName }} {{ user.lastName }}</strong>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <app-badge [variant]="getRoleBadgeVariant(user.role)">
                  {{ user.role }}
                </app-badge>
              </td>
              <td>
                <app-badge [variant]="getStatusVariant(user.status)">
                  {{ user.status }}
                </app-badge>
              </td>
              <td>
                @if (user.pointsBalance !== undefined) {
                  <span class="points-value">
                    {{ user.pointsBalance }} pts
                  </span>
                } @else {
                  <span class="no-points">
                    N/A
                  </span>
                }
              </td>
              <td>{{ user.createdAt | date: 'MMM dd, yyyy' }}</td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="action-btn edit-btn" 
                    (click)="openEditModal(user)" 
                    title="Edit"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button 
                    class="action-btn" 
                    [class.toggle-active]="user.status === 'Active'"
                    [class.toggle-inactive]="user.status === 'Inactive'"
                    (click)="toggleUserStatus(user)" 
                    [title]="user.status === 'Active' ? 'Deactivate' : 'Activate'"
                  >
                    {{ user.status === 'Active' ? 'üîí' : '‚úÖ' }}
                  </button>
                  <button 
                    class="action-btn delete-btn" 
                    (click)="deleteUser(user.id)" 
                    title="Delete"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </app-card>
</div>

<!-- User Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalMode() === 'create' ? 'Add New User' : 'Edit User' }}</h3>
        <button class="close-btn" (click)="closeModal()">‚úï</button>
      </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        @if (modalValidationErrors.length > 0) {
          <div class="error-list">
            @for (error of modalValidationErrors; track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }
        
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <input
              id="firstName"
              type="text"
              [(ngModel)]="selectedUser.firstName"
              name="firstName"
              placeholder="Enter first name"
              required
              maxlength="100"
              pattern="^[a-zA-Z ]+$"
            />
            <small class="form-hint">Only letters and spaces allowed (1-100 characters)</small>
          </div>

          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <input
              id="lastName"
              type="text"
              [(ngModel)]="selectedUser.lastName"
              name="lastName"
              placeholder="Enter last name"
              required
              maxlength="100"
              pattern="^[a-zA-Z ]+$"
            />
            <small class="form-hint">Only letters and spaces allowed (1-100 characters)</small>
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input
            id="email"
            type="email"
            [(ngModel)]="selectedUser.email"
            name="email"
            placeholder="user@agdata.com"
            required
            maxlength="255"
          />
          <small class="form-hint">Must be a valid email address (max 255 characters)</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="role">Role *</label>
            <select
              id="role"
              [(ngModel)]="selectedUser.role"
              name="role"
              required
            >
              <option value="Employee">Employee</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="form-group">
            <label for="status">Status *</label>
            <select
              id="status"
              [(ngModel)]="selectedUser.status"
              name="status"
              required
            >
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>

        @if (modalMode() === 'create') {
          <div class="form-group">
            <label for="password">Initial Password *</label>
            <input
              id="password"
              type="password"
              [(ngModel)]="selectedUser.password"
              placeholder="Enter initial password"
              name="password"
              required
              minlength="8"
            />
            <small class="form-help">Min 8 characters, must include: uppercase, lowercase, number, and special character</small>
          </div>
        }

        @if (modalMode() === 'edit') {
          <div class="info-box">
            <strong>‚ÑπÔ∏è Note:</strong> User's password cannot be changed from here. Use the password reset feature.
          </div>
        }
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveUser()">
        {{ modalMode() === 'create' ? 'Create User' : 'Save Changes' }}
      </app-button>
    </div>
    </div>
  </div>
}
