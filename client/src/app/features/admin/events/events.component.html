<div class="events-container">
  <!-- Quick Actions -->
  <div class="quick-actions-bar">
    <button class="quick-action-btn primary" (click)="openCreateModal()">
      <span class="action-icon">â•</span>
      <span>Create New Event</span>
    </button>
    <button class="quick-action-btn secondary" (click)="refreshData()">
      <span class="action-icon">ğŸ”„</span>
      <span>Refresh</span>
    </button>
  </div>

  <app-card>
    <!-- Header with Create Button -->
    <div header class="events-header">
      <div>
        <h2>Events Management</h2>
        <p class="subtitle">Manage all events and reward activities</p>
      </div>
      <app-button (clicked)="openCreateModal()">
        â• Create Event
      </app-button>
    </div>

    <!-- Filters & Search -->
    <div class="filters-section">
      <div class="filter-tabs">
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'all'"
          (click)="onFilterChange('all')">
          All Events
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Draft'"
          (click)="onFilterChange('Draft')">
          Draft
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Upcoming'"
          (click)="onFilterChange('Upcoming')">
          Upcoming
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Active'"
          (click)="onFilterChange('Active')">
          Active
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Completed'"
          (click)="onFilterChange('Completed')">
          Completed
        </button>
      </div>

      <div class="search-box">
        <input
          type="text"
          placeholder="Search events..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          class="search-input"
        />
        <span class="search-icon">ğŸ”</span>
      </div>
    </div>

    <!-- Events Table -->
    <div class="table-container">
      <table class="events-table">
        <thead>
          <tr>
            <th>Event Name</th>
            <th>Date</th>
            <th>Status</th>
            <th>Points Pool</th>
            <th>Remaining Points</th>
            <th>Participants</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (event of filteredEvents(); track event.id) {
            <tr>
              <td>
                <div class="event-name">
                  <strong>{{ event.name }}</strong>
                  <span class="event-description">{{ event.description }}</span>
                </div>
              </td>
              <td>{{ event.eventDate | date: 'MMM dd, yyyy' }}</td>
              <td>
                <app-badge [variant]="getStatusVariant(event.status)">
                  {{ event.status }}
                </app-badge>
              </td>
              <td>
                <span class="points-value">{{ event.pointsPool }} pts</span>
              </td>
              <td>
                <span class="points-value remaining-points" [class.low-points]="event.remainingPoints < event.pointsPool * 0.2">
                  {{ event.remainingPoints }} pts
                </span>
              </td>
              <td>
                <span class="participant-count">{{ event.participantCount }} users</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="action-btn edit-btn" (click)="openEditModal(event)" title="Edit">
                    âœï¸
                  </button>
                  <button class="action-btn participants-btn" (click)="openParticipantsModal(event)" title="View Participants">
                    ğŸ‘¥
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteEvent(event.id)" title="Delete">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </app-card>
</div>

<!-- Event Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalMode() === 'create' ? 'Create New Event' : 'Edit Event' }}</h3>
        <button class="close-btn" (click)="closeModal()">âœ•</button>
      </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        @if (eventModalValidationErrors.length > 0) {
          <div class="error-list">
            @for (error of eventModalValidationErrors; track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }
        
        <div class="form-group">
          <label for="eventName">Event Name *</label>
          <input
            id="eventName"
            type="text"
            [(ngModel)]="selectedEvent.name"
            name="name"
            placeholder="Enter event name"
            required
            minlength="3"
            maxlength="200"
          />
          <small class="form-hint">3-200 characters required</small>
        </div>

        <div class="form-group">
          <label for="eventDescription">Description</label>
          <textarea
            id="eventDescription"
            [(ngModel)]="selectedEvent.description"
            name="description"
            placeholder="Enter event description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventDate">Event Date *</label>
            <input
              id="eventDate"
              type="date"
              [(ngModel)]="selectedEvent.eventDate"
              name="eventDate"
              required
              placeholder="YYYY-MM-DD"
            />
            <small class="form-hint">Must be a future date</small>
          </div>

          <div class="form-group">
            <label for="eventStatus">Status *</label>
            <select
              id="eventStatus"
              [(ngModel)]="selectedEvent.status"
              name="status"
              required
            >
              <option value="Draft">Draft</option>
              <option value="Upcoming">Upcoming</option>
              <option value="Active">Active</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pointsPool">Points Pool *</label>
            <input
              id="pointsPool"
              type="number"
              [(ngModel)]="selectedEvent.pointsPool"
              name="pointsPool"
              placeholder="0"
              required
              min="1"
              max="1000000"
            />
            <small class="form-hint">Must be greater than 0, max 1,000,000</small>
          </div>

          <div class="form-group">
            <label for="maxParticipants">Max Participants</label>
            <input
              id="maxParticipants"
              type="number"
              [(ngModel)]="selectedEvent.maxParticipants"
              name="maxParticipants"
              placeholder="0 (unlimited)"
              min="0"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">Event Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="selectedEvent.imageUrl"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
          />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveEvent()">
        {{ modalMode() === 'create' ? 'Create Event' : 'Save Changes' }}
      </app-button>
    </div>
    </div>
  </div>
}

<!-- Participants Modal -->
@if (showParticipantsModal()) {
  <div class="modal-overlay" (click)="closeParticipantsModal()">
    <div class="modal-content participants-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h3>{{ selectedEventForParticipants()?.name }} - Participants</h3>
          <p class="participants-count">Total Participants: {{ filteredParticipants().length }}</p>
          <p class="remaining-pool-info">
            <strong>Remaining Points Pool:</strong> 
            <span [class.low-points]="(selectedEventForParticipants()?.remainingPoints ?? 0) < (selectedEventForParticipants()?.pointsPool ?? 0) * 0.2">
              {{ selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool }} / {{ selectedEventForParticipants()?.pointsPool }} pts
            </span>
          </p>
        </div>
        <button class="close-btn" (click)="closeParticipantsModal()">âœ•</button>
      </div>
    <div class="modal-body">
      <!-- Search Bar -->
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          [ngModel]="participantSearchQuery()"
          (ngModelChange)="participantSearchQuery.set($event); filterParticipants()"
          placeholder="ğŸ” Search by name or email..."
        />
      </div>

      <!-- Participants Table -->
      <div class="participants-table-container">
        <table class="participants-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Registration Date</th>
              <th>Status</th>
              <th>Rank</th>
              <th>Points</th>
              <th>Actions</th>
            </tr>
          </thead>
            <tbody>
              @for (participant of filteredParticipants(); track participant.userId) {
                <tr [class.awarded-row]="participant.pointsAwarded || participant.status === 'Awarded'">
                  <td>
                    <strong>{{ participant.userName }}</strong>
                  </td>
                  <td>{{ participant.userEmail }}</td>
                  <td>{{ participant.registeredAt | date: 'MMM dd, yyyy' }}</td>
                  <td>
                    <app-badge [variant]="getParticipantStatusVariant(participant.status)">
                      {{ participant.pointsAwarded ? 'Awarded' : participant.status }}
                    </app-badge>
                  </td>
                  <td>
                    @if (participant.eventRank) {
                      <span class="rank-badge">
                        ğŸ† #{{ participant.eventRank }}
                      </span>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    @if (participant.pointsAwarded) {
                      <span class="points-awarded">
                        {{ participant.pointsAwarded }} pts
                      </span>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    <button 
                      class="select-winner-btn"
                      (click)="openWinnerSelectionModal(participant)"
                      [disabled]="participant.pointsAwarded || participant.status === 'Awarded'"
                      [class.disabled-btn]="participant.pointsAwarded || participant.status === 'Awarded'"
                      title="{{ (participant.pointsAwarded || participant.status === 'Awarded') ? 'Points already awarded' : 'Award points to this participant' }}">
                      {{ (participant.pointsAwarded || participant.status === 'Awarded') ? 'âœ“ Awarded' : 'ğŸ† Award Points' }}
                    </button>
                  </td>
                </tr>
              }
              @if (filteredParticipants().length === 0) {
                <tr>
                  <td colspan="5" style="text-align: center; padding: 32px; color: #7A7A7A;">
                    No participants found
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
}
<!-- Winner Selection Modal -->
@if (showWinnerModal()) {
  <div class="modal-overlay" (click)="closeWinnerModal()">
    <div class="modal-content winner-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ† Award Points</h3>
        <button class="close-btn" (click)="closeWinnerModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="winner-info">
          <p><strong>Participant:</strong> {{ selectedParticipant()?.userName }}</p>
          <p><strong>Email:</strong> {{ selectedParticipant()?.userEmail }}</p>
          <p><strong>Event:</strong> {{ selectedEventForParticipants()?.name }}</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="winnerRank">Rank Position *</label>
            <input
              id="winnerRank"
              type="number"
              [ngModel]="winnerRank()"
              (ngModelChange)="winnerRank.set($event)"
              name="winnerRank"
              placeholder="Enter rank (1, 2, 3...)"
              min="1"
              required
            />
            <span class="input-hint">Winner's rank position (1st, 2nd, 3rd, etc.)</span>
          </div>

          <div class="form-group">
            <label for="pointsToAward">Points to Award *</label>
            <input
              id="pointsToAward"
              type="number"
              [ngModel]="pointsToAward()"
              (ngModelChange)="pointsToAward.set($event)"
              name="pointsToAward"
              placeholder="Enter points"
              min="1"
              [max]="selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool ?? 0"
              required
            />
            <span class="input-hint">
              Remaining pool: {{ selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool ?? 0 }} / {{ selectedEventForParticipants()?.pointsPool ?? 0 }} points
            </span>
          </div>
        </div>

        @if (winnerValidationError()) {
          <div class="error-message-box">
            {{ winnerValidationError() }}
          </div>
        }
      </div>

      <div class="modal-footer">
        <app-button variant="secondary" (clicked)="closeWinnerModal()">
          Cancel
        </app-button>
        <app-button (clicked)="confirmWinnerSelection()">
          Confirm & Award Points
        </app-button>
      </div>
    </div>
  </div>
}
