<div class="events-container">
  <!-- Quick Actions -->
  <div class="quick-actions-bar">
    <button class="quick-action-btn primary" (click)="openCreateModal()">
      <span class="action-icon">‚ûï</span>
      <span>Create New Event</span>
    </button>
    <!-- <button class="quick-action-btn secondary" (click)="refreshData()">
      <span class="action-icon">üîÑ</span>
      <span>Refresh</span>
    </button> -->
  </div>

  <app-card>
    <!-- Header with Create Button -->
    <div header class="events-header">
      <div>
        <h2>Events Management</h2>
        <p class="subtitle">Manage all events and reward activities</p>
      </div>
      <app-button (clicked)="openCreateModal()">
        ‚ûï Create Event
      </app-button>
    </div>

    <!-- Filters & Search -->
    <div class="filters-section">
      <div class="filter-tabs">
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'all'"
          (click)="onFilterChange('all')">
          All Events
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Draft'"
          (click)="onFilterChange('Draft')">
          Draft
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Upcoming'"
          (click)="onFilterChange('Upcoming')">
          Upcoming
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Active'"
          (click)="onFilterChange('Active')">
          Active
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedFilter() === 'Completed'"
          (click)="onFilterChange('Completed')">
          Completed
        </button>
      </div>

      <div class="search-row">
        <div class="search-box">
          <input
            type="text"
            placeholder="Search events..."
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            class="search-input"
          />
          <span class="search-icon">üîç</span>
        </div>
        <div class="results-info">
          Showing {{ filteredEvents().length }} of {{ events().length }} events
        </div>
      </div>
    </div>

    <!-- Events Table -->
    <div class="table-container">
      <table class="events-table">
        <thead>
          <tr>
            <th class="sortable" (click)="toggleSort('name')">
              Event Name <span class="sort-icon">{{ getSortIcon('name') }}</span>
            </th>
            <th class="sortable" (click)="toggleSort('eventDate')">
              Date <span class="sort-icon">{{ getSortIcon('eventDate') }}</span>
            </th>
            <th class="sortable" (click)="toggleSort('status')">
              Status <span class="sort-icon">{{ getSortIcon('status') }}</span>
            </th>
            <th class="sortable" (click)="toggleSort('pointsPool')">
              Points Pool <span class="sort-icon">{{ getSortIcon('pointsPool') }}</span>
            </th>
            <th>Prizes</th>
            <th class="sortable" (click)="toggleSort('participantCount')">
              Participants <span class="sort-icon">{{ getSortIcon('participantCount') }}</span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (event of filteredEvents(); track event.id) {
            <tr>
              <td>
                <div class="event-name">
                  <strong>{{ event.name }}</strong>
                  <span class="event-description">{{ event.description }}</span>
                </div>
              </td>
              <td>{{ event.eventDate | date: 'MMM dd, yyyy' }}</td>
              <td>
                <app-badge [variant]="getStatusVariant(event.status)">
                  {{ event.status }}
                </app-badge>
              </td>
              <td>
                <span class="points-value">{{ event.pointsPool }} pts</span>
              </td>
              <td>
                @if (event.firstPlacePoints || event.secondPlacePoints || event.thirdPlacePoints) {
                  <div class="prize-badges">
                    @if (event.firstPlacePoints) {
                      <span class="prize-badge gold">ü•á {{ event.firstPlacePoints }}</span>
                    }
                    @if (event.secondPlacePoints) {
                      <span class="prize-badge silver">ü•à {{ event.secondPlacePoints }}</span>
                    }
                    @if (event.thirdPlacePoints) {
                      <span class="prize-badge bronze">ü•â {{ event.thirdPlacePoints }}</span>
                    }
                  </div>
                } @else {
                  <span class="no-prizes">-</span>
                }
              </td>
              <td>
                <span class="participant-count">{{ event.participantCount }} users</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="action-btn edit-btn" (click)="openEditModal(event)" title="Edit">
                    ‚úèÔ∏è
                  </button>
                  <button class="action-btn participants-btn" (click)="openParticipantsModal(event)" title="View Participants">
                    üë•
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteEvent(event.id)" title="Delete">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
          
          @if (filteredEvents().length === 0) {
            <tr>
              <td colspan="7" class="no-results">
                <div class="no-results-content">
                  <span class="no-results-icon">üéâ</span>
                  @if (searchQuery()) {
                    <p>No events found matching "{{ searchQuery() }}"</p>
                    <button class="clear-filters-link" (click)="clearFilters()">Clear filters</button>
                  } @else {
                    <p>No {{ selectedFilter() === 'all' ? '' : selectedFilter().toLowerCase() }} events at the moment.</p>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </app-card>
</div>

<!-- Event Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalMode() === 'create' ? 'Create New Event' : 'Edit Event' }}</h3>
        <button class="close-btn" (click)="closeModal()">‚úï</button>
      </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        @if (eventModalValidationErrors.length > 0) {
          <div class="error-list">
            @for (error of eventModalValidationErrors; track $index) {
              <div class="error">{{ error }}</div>
            }
          </div>
        }
        
        <div class="form-group">
          <label for="eventName">Event Name *</label>
          <input
            id="eventName"
            type="text"
            [(ngModel)]="selectedEvent.name"
            name="name"
            placeholder="Enter event name"
            required
            minlength="3"
            maxlength="200"
          />
          <small class="form-hint">3-200 characters required</small>
        </div>

        <div class="form-group">
          <label for="eventDescription">Description</label>
          <textarea
            id="eventDescription"
            [(ngModel)]="selectedEvent.description"
            name="description"
            placeholder="Enter event description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventDate">Event Start Date *</label>
            <input
              id="eventDate"
              type="date"
              [(ngModel)]="selectedEvent.eventDate"
              name="eventDate"
              required
              placeholder="YYYY-MM-DD"
            />
            <small class="form-hint">Must be a future date</small>
          </div>

          <div class="form-group">
            <label for="eventEndDate">Event End Date</label>
            <input
              id="eventEndDate"
              type="date"
              [(ngModel)]="selectedEvent.eventEndDate"
              name="eventEndDate"
              placeholder="YYYY-MM-DD"
            />
            <small class="form-hint">Leave empty for single-day events</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventStatus">Status *</label>
            <select
              id="eventStatus"
              [(ngModel)]="selectedEvent.status"
              name="status"
              required
            >
              <option value="Draft">Draft</option>
              <option value="Upcoming">Upcoming</option>
              <option value="Active">Active</option>
              <option value="Completed">Completed</option>
            </select>
          </div>

          <div class="form-group">
            <label for="maxParticipants">Max Participants</label>
            <input
              id="maxParticipants"
              type="number"
              [(ngModel)]="selectedEvent.maxParticipants"
              name="maxParticipants"
              placeholder="0 (unlimited)"
              min="0"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pointsPool">Points Pool *</label>
            <input
              id="pointsPool"
              type="number"
              [(ngModel)]="selectedEvent.pointsPool"
              name="pointsPool"
              placeholder="0"
              required
              min="1"
              max="1000000"
            />
            <small class="form-hint">Must be greater than 0, max 1,000,000</small>
          </div>
        </div>

        <!-- Prize Distribution Section -->
        <div class="form-section">
          <h4 class="form-section-title">üèÜ Prize Distribution (Optional)</h4>
          <p class="form-section-hint">Set point rewards for top performers</p>
          
          <div class="form-row prize-row">
            <div class="form-group prize-input first-place">
              <label for="firstPlacePoints">ü•á 1st Place</label>
              <input
                id="firstPlacePoints"
                type="number"
                [(ngModel)]="selectedEvent.firstPlacePoints"
                name="firstPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>

            <div class="form-group prize-input second-place">
              <label for="secondPlacePoints">ü•à 2nd Place</label>
              <input
                id="secondPlacePoints"
                type="number"
                [(ngModel)]="selectedEvent.secondPlacePoints"
                name="secondPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>

            <div class="form-group prize-input third-place">
              <label for="thirdPlacePoints">ü•â 3rd Place</label>
              <input
                id="thirdPlacePoints"
                type="number"
                [(ngModel)]="selectedEvent.thirdPlacePoints"
                name="thirdPlacePoints"
                placeholder="0"
                min="0"
              />
            </div>
          </div>
        </div>

        <!-- Registration Period Section -->
        <div class="form-section">
          <h4 class="form-section-title">üìÖ Registration Period (Optional)</h4>
          
          <div class="form-row">
            <div class="form-group">
              <label for="registrationStartDate">Registration Opens</label>
              <input
                id="registrationStartDate"
                type="date"
                [(ngModel)]="selectedEvent.registrationStartDate"
                name="registrationStartDate"
                placeholder="YYYY-MM-DD"
              />
            </div>

            <div class="form-group">
              <label for="registrationEndDate">Registration Closes</label>
              <input
                id="registrationEndDate"
                type="date"
                [(ngModel)]="selectedEvent.registrationEndDate"
                name="registrationEndDate"
                placeholder="YYYY-MM-DD"
              />
            </div>
          </div>
        </div>

        <!-- Location Section -->
        <div class="form-section">
          <h4 class="form-section-title">üìç Event Location (Optional)</h4>
          
          <div class="form-group">
            <label for="location">Physical Location</label>
            <input
              id="location"
              type="text"
              [(ngModel)]="selectedEvent.location"
              name="location"
              placeholder="e.g., Conference Room A, Building 1"
            />
          </div>

          <div class="form-group">
            <label for="virtualLink">Virtual Meeting Link</label>
            <input
              id="virtualLink"
              type="url"
              [(ngModel)]="selectedEvent.virtualLink"
              name="virtualLink"
              placeholder="https://zoom.us/j/meeting-id"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">Event Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="selectedEvent.imageUrl"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
          />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveEvent()">
        {{ modalMode() === 'create' ? 'Create Event' : 'Save Changes' }}
      </app-button>
    </div>
    </div>
  </div>
}

<!-- Participants Modal -->
@if (showParticipantsModal()) {
  <div class="modal-overlay" (click)="closeParticipantsModal()">
    <div class="modal-content participants-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h3>{{ selectedEventForParticipants()?.name }} - Participants</h3>
          <p class="participants-count">Total Participants: {{ filteredParticipants().length }}</p>
          <p class="remaining-pool-info">
            <strong>Remaining Points Pool:</strong> 
            <span [class.low-points]="(selectedEventForParticipants()?.remainingPoints ?? 0) < (selectedEventForParticipants()?.pointsPool ?? 0) * 0.2">
              {{ selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool }} / {{ selectedEventForParticipants()?.pointsPool }} pts
            </span>
          </p>
        </div>
        <button class="close-btn" (click)="closeParticipantsModal()">‚úï</button>
      </div>
    <div class="modal-body">
      <!-- Search Bar -->
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          [ngModel]="participantSearchQuery()"
          (ngModelChange)="participantSearchQuery.set($event); filterParticipants()"
          placeholder="üîç Search by name or email..."
        />
      </div>

      <!-- Participants Table -->
      <div class="participants-table-container">
        <table class="participants-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Registration Date</th>
              <th>Status</th>
              <th>Rank</th>
              <th>Points</th>
              <th>Actions</th>
            </tr>
          </thead>
            <tbody>
              @for (participant of filteredParticipants(); track participant.userId) {
                <tr [class.awarded-row]="participant.pointsAwarded || participant.status === 'Awarded'">
                  <td>
                    <strong>{{ participant.userName }}</strong>
                  </td>
                  <td>{{ participant.userEmail }}</td>
                  <td>{{ participant.registeredAt | date: 'MMM dd, yyyy' }}</td>
                  <td>
                    <app-badge [variant]="getParticipantStatusVariant(participant.status)">
                      {{ participant.pointsAwarded ? 'Awarded' : participant.status }}
                    </app-badge>
                  </td>
                  <td>
                    @if (participant.eventRank) {
                      <span class="rank-badge">
                        üèÜ #{{ participant.eventRank }}
                      </span>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    @if (participant.pointsAwarded) {
                      <span class="points-awarded">
                        {{ participant.pointsAwarded }} pts
                      </span>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    <button 
                      class="select-winner-btn"
                      (click)="openWinnerSelectionModal(participant)"
                      [disabled]="participant.pointsAwarded || participant.status === 'Awarded'"
                      [class.disabled-btn]="participant.pointsAwarded || participant.status === 'Awarded'"
                      title="{{ (participant.pointsAwarded || participant.status === 'Awarded') ? 'Points already awarded' : 'Award points to this participant' }}">
                      {{ (participant.pointsAwarded || participant.status === 'Awarded') ? '‚úì Awarded' : 'üèÜ Award Points' }}
                    </button>
                  </td>
                </tr>
              }
              @if (filteredParticipants().length === 0) {
                <tr>
                  <td colspan="5" style="text-align: center; padding: 32px; color: #7A7A7A;">
                    No participants found
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
}
<!-- Winner Selection Modal -->
@if (showWinnerModal()) {
  <div class="modal-overlay" (click)="closeWinnerModal()">
    <div class="modal-content winner-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üèÜ Award Points</h3>
        <button class="close-btn" (click)="closeWinnerModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="winner-info">
          <p><strong>Participant:</strong> {{ selectedParticipant()?.userName }}</p>
          <p><strong>Email:</strong> {{ selectedParticipant()?.userEmail }}</p>
          <p><strong>Event:</strong> {{ selectedEventForParticipants()?.name }}</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="winnerRank">Rank Position *</label>
            <input
              id="winnerRank"
              type="number"
              [ngModel]="winnerRank()"
              (ngModelChange)="winnerRank.set($event)"
              name="winnerRank"
              placeholder="Enter rank (1, 2, 3...)"
              min="1"
              required
            />
            <span class="input-hint">Winner's rank position (1st, 2nd, 3rd, etc.)</span>
          </div>

          <div class="form-group">
            <label for="pointsToAward">Points to Award *</label>
            <input
              id="pointsToAward"
              type="number"
              [ngModel]="pointsToAward()"
              (ngModelChange)="pointsToAward.set($event)"
              name="pointsToAward"
              placeholder="Enter points"
              min="1"
              [max]="selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool ?? 0"
              required
            />
            <span class="input-hint">
              Remaining pool: {{ selectedEventForParticipants()?.remainingPoints ?? selectedEventForParticipants()?.pointsPool ?? 0 }} / {{ selectedEventForParticipants()?.pointsPool ?? 0 }} points
            </span>
          </div>
        </div>

        @if (winnerValidationError()) {
          <div class="error-message-box">
            {{ winnerValidationError() }}
          </div>
        }
      </div>

      <div class="modal-footer">
        <app-button variant="secondary" (clicked)="closeWinnerModal()">
          Cancel
        </app-button>
        <app-button (clicked)="confirmWinnerSelection()">
          Confirm & Award Points
        </app-button>
      </div>
    </div>
  </div>
}
