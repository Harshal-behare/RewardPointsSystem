<div class="products-container">
  <!-- Quick Actions -->
  <div class="quick-actions-bar">
    <button class="quick-action-btn primary" (click)="openCreateModal()">
      <span class="action-icon"><app-icon name="add" [size]="18"></app-icon></span>
      <span>Add New Product</span>
    </button>
    <button class="quick-action-btn secondary" (click)="openCategoryModal()">
      <span class="action-icon"><app-icon name="folder" [size]="18"></app-icon></span>
      <span>Manage Categories</span>
    </button>
    <!-- <button class="quick-action-btn secondary" (click)="refreshData()">
      <span class="action-icon"><app-icon name="refresh" [size]="16"></app-icon></span>
      <span>Refresh</span>
    </button> -->
  </div>

  <app-card>
    <!-- Header -->
    <div header class="products-header">
      <div>
        <h2>Products Management</h2>
        <p class="subtitle">Manage product catalog and inventory</p>
      </div>
      <div class="header-actions">
        <button class="view-toggle" (click)="toggleViewMode()">
          <app-icon [name]="viewMode() === 'grid' ? 'table' : 'grid'" [size]="16"></app-icon> {{ viewMode() === 'grid' ? 'Table View' : 'Grid View' }}
        </button>
        <app-button (clicked)="openCreateModal()">
          <app-icon name="add" [size]="16"></app-icon> Add Product
        </app-button>
      </div>
    </div>

    <!-- Filters & Search -->
    <div class="filters-section">
      <div class="filter-tabs">
        <button
          class="filter-tab"
          [class.active]="selectedCategory() === 'all'"
          (click)="onCategoryChange('all')">
          All Products
        </button>
        @for (category of categories().slice(1); track category) {
          <button
            class="filter-tab"
            [class.active]="selectedCategory() === category"
            (click)="onCategoryChange(category)">
            {{ category }}
          </button>
        }
      </div>

      <!-- Status Filter -->
      <div class="status-filter">
        <select 
          class="status-select"
          [ngModel]="selectedStatus()"
          (ngModelChange)="onStatusChange($event)">
          <option value="all">All Status</option>
          <option value="Active">Active Only</option>
          <option value="Inactive">Inactive Only</option>
        </select>
      </div>

      <div class="search-box">
        <input
          type="text"
          placeholder="Search products..."
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event); onSearchChange()"
          class="search-input"
        />
        <span class="search-icon"><app-icon name="search" [size]="18"></app-icon></span>
      </div>
    </div>

    <!-- Grid View -->
    @if (viewMode() === 'grid') {
      <div class="products-grid">
        @for (product of filteredProducts(); track product.id) {
          <div class="product-card">
            <div class="product-image">
              <img [src]="product.imageUrl" [alt]="product.name" (error)="handleImageError($event)" />
              <app-badge 
                [variant]="getStatusVariant(product.status)" 
                class="status-badge"
              >
                {{ product.status }}
              </app-badge>
            </div>
            <div class="product-info">
              <span class="product-category">{{ product.category }}</span>
              <h3 class="product-name">{{ product.name }}</h3>
              <p class="product-description">{{ product.description }}</p>
              <div class="product-footer">
                <div class="product-price">
                  <span class="points-label">Points:</span>
                  <span class="points-value">{{ product.pointsPrice }}</span>
                </div>
                <div class="product-stock">
                  @if (product.stock === 0) {
                    <app-badge variant="danger" size="sm">Out of Stock</app-badge>
                  } @else if (product.stock < 10) {
                    <app-badge variant="warning" size="sm">{{ product.stock }} units</app-badge>
                  } @else {
                    <app-badge variant="success" size="sm">{{ product.stock }} units</app-badge>
                  }
                </div>
              </div>
              <div class="product-actions">
                <app-button size="sm" variant="secondary" (clicked)="openEditModal(product)">
                  <app-icon name="edit" [size]="14"></app-icon> Edit
                </app-button>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Table View -->
    @if (viewMode() === 'table') {
      <div class="table-container">
        <table class="products-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Points Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (product of filteredProducts(); track product.id) {
              <tr>
                <td>
                  <div class="table-product">
                    <img [src]="product.imageUrl" [alt]="product.name" class="table-product-image" (error)="handleImageError($event)" />
                    <div>
                      <strong>{{ product.name }}</strong>
                      <span class="table-description">{{ product.description }}</span>
                    </div>
                  </div>
                </td>
                <td>{{ product.category }}</td>
                <td>
                  <span class="points-value">{{ product.pointsPrice }} pts</span>
                </td>
                <td>
                  <div class="stock-info">
                    <app-badge [variant]="getStockStatus(product.stock).variant" size="sm">
                      {{ product.stock }} units
                    </app-badge>
                  </div>
                </td>
                <td>
                  <app-badge [variant]="getStatusVariant(product.status)">
                    {{ product.status }}
                  </app-badge>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="action-btn edit-btn" (click)="openEditModal(product)" title="Edit">
                      <app-icon name="edit" [size]="16"></app-icon>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </app-card>
</div>

<!-- Product Modal -->
@if (showModal()) {
  <div class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalMode() === 'create' ? 'Add New Product' : 'Edit Product' }}</h3>
      </div>

      <div class="modal-body">
        <form>
          <!-- Validation Errors -->
          @if (modalValidationErrors.length > 0) {
            <div class="error-list">
              @for (error of modalValidationErrors; track $index) {
                <div class="error">{{ error }}</div>
              }
            </div>
          }
        
        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input
            id="productName"
            type="text"
            [(ngModel)]="selectedProduct.name"
            (ngModelChange)="validateProductModalRealtime()"
            name="name"
            placeholder="Enter product name"
            required
            minlength="2"
            maxlength="200"
            [class.invalid]="selectedProduct.name !== undefined && (selectedProduct.name.trim().length || 0) < 2"
          />
          <small class="form-hint">2-200 characters required</small>
        </div>
        <div class="form-group">
          <label for="productDescription">Description</label>
          <textarea
            id="productDescription"
            [(ngModel)]="selectedProduct.description"
            (ngModelChange)="validateProductModalRealtime()"
            name="description"
            placeholder="Enter product description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select
              id="category"
              [(ngModel)]="selectedProduct.categoryId"
              (ngModelChange)="validateProductModalRealtime()"
              name="categoryId"
              required
              [class.invalid]="!selectedProduct.categoryId"
            >
              <option value="">Select a category</option>
              @for (cat of dbCategories(); track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label for="pointsPrice">Points Price *</label>
            <input
              id="pointsPrice"
              type="number"
              [(ngModel)]="selectedProduct.pointsPrice"
              (ngModelChange)="validateProductModalRealtime()"
              name="pointsPrice"
              placeholder="Enter points price"
              required
              min="1"
              [class.invalid]="selectedProduct.pointsPrice !== undefined && (selectedProduct.pointsPrice || 0) < 1"
            />
            <small class="form-hint">Must be at least 1</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="stock">Stock Quantity *</label>
            <input
              id="stock"
              type="number"
              [(ngModel)]="selectedProduct.stock"
              (ngModelChange)="validateProductModalRealtime()"
              name="stock"
              placeholder="Enter stock quantity"
              required
              min="0"
              [class.invalid]="selectedProduct.stock !== undefined && selectedProduct.stock < 0"
            />
            <small class="form-hint">Cannot be negative</small>
          </div>
          <div class="form-group">
            <label for="status">Status *</label>
            <select
              id="status"
              [(ngModel)]="selectedProduct.status"
              (ngModelChange)="validateProductModalRealtime()"
              name="status"
              required
            >
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="imageUrl">Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="selectedProduct.imageUrl"
            (ngModelChange)="validateProductModalRealtime()"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
            maxlength="500"
          />
          <small class="form-hint">Must be a valid URL (http:// or https://), max 500 characters</small>
          
          <!-- Image Preview -->
          @if (selectedProduct.imageUrl) {
            <div class="image-preview">
              <img [src]="selectedProduct.imageUrl" alt="Product Preview" (error)="handleImageError($event)" />
            </div>
          }
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeModal()">
        Cancel
      </app-button>
      <app-button 
        (clicked)="saveProduct()"
        [disabled]="!isProductFormValid()"
        [class.disabled-btn]="!isProductFormValid()">
        {{ modalMode() === 'create' ? 'Add Product' : 'Save Changes' }}
      </app-button>
    </div>
    </div>
  </div>
}

<!-- Category Management Modal -->
@if (showCategoryModal()) {
  <div class="modal-overlay">
    <div class="modal-content category-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><app-icon name="folder" [size]="20"></app-icon> Manage Categories</h3>
      </div>

      <div class="modal-body">
        <div class="category-actions">
          <app-button (clicked)="openCreateCategoryForm()">
            <app-icon name="plus" [size]="14"></app-icon> Add Category
          </app-button>
        </div>

        @if (allCategories().length > 0) {
          <div class="categories-list">
            <table class="categories-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Order</th>
                  <th>Products</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (category of allCategories(); track category.id) {
                  <tr [class.inactive-row]="!category.isActive">
                    <td>
                      <strong>{{ category.name }}</strong>
                    </td>
                    <td class="description-cell">{{ category.description || '-' }}</td>
                    <td>{{ category.displayOrder }}</td>
                    <td>
                      <app-badge [variant]="category.productCount > 0 ? 'info' : 'secondary'" size="sm">
                        {{ category.productCount }}
                      </app-badge>
                    </td>
                    <td>
                      <app-badge [variant]="category.isActive ? 'success' : 'secondary'" size="sm">
                        {{ category.isActive ? 'Active' : 'Inactive' }}
                      </app-badge>
                    </td>
                    <td>
                      <div class="category-action-buttons">
                        <button class="action-btn edit-btn" (click)="openEditCategoryForm(category)" title="Edit">
                          <app-icon name="edit" [size]="14"></app-icon>
                        </button>
                        <button 
                          class="action-btn toggle-btn" 
                          (click)="toggleCategoryStatus(category)" 
                          [title]="category.isActive ? 'Deactivate' : 'Activate'"
                          [class.deactivate]="category.isActive"
                          [class.activate]="!category.isActive">
                          @if (category.isActive) {
                            <app-icon name="ban" [size]="14"></app-icon>
                          } @else {
                            <app-icon name="check" [size]="14"></app-icon>
                          }
                        </button>
                        <button 
                          class="action-btn delete-btn" 
                          (click)="deleteCategory(category)" 
                          title="Delete"
                          [disabled]="category.productCount > 0">
                          <app-icon name="trash" [size]="14"></app-icon>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="empty-categories">
            <p>No categories found. Click "Add Category" to create one.</p>
          </div>
        }
      </div>

      <div class="modal-footer">
        <app-button variant="secondary" (clicked)="closeCategoryModal()">
          Close
        </app-button>
      </div>
    </div>
  </div>
}

<!-- Category Form Modal (Add/Edit) -->
@if (showCategoryFormModal()) {
  <div class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          @if (categoryModalMode() === 'create') {
            <app-icon name="plus" [size]="18"></app-icon> Add New Category
          } @else {
            <app-icon name="edit" [size]="18"></app-icon> Edit Category
          }
        </h3>
      </div>

      <div class="modal-body">
        <form>
          <!-- Validation Errors -->
          @if (categoryValidationErrors.length > 0) {
            <div class="error-list">
              @for (error of categoryValidationErrors; track $index) {
                <div class="error">{{ error }}</div>
              }
            </div>
          }
        
        <div class="form-group">
          <label for="categoryName">Category Name *</label>
          <input
            id="categoryName"
            type="text"
            [(ngModel)]="selectedCategoryItem.name"
            name="categoryName"
            placeholder="Enter category name"
            required
            minlength="2"
            maxlength="100"
          />
          <small class="form-hint">2-100 characters required</small>
        </div>

        <div class="form-group">
          <label for="categoryDescription">Description</label>
          <textarea
            id="categoryDescription"
            [(ngModel)]="selectedCategoryItem.description"
            name="categoryDescription"
            placeholder="Enter category description (optional)"
            rows="3"
            maxlength="500"
          ></textarea>
          <small class="form-hint">Max 500 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="displayOrder">Display Order</label>
            <input
              id="displayOrder"
              type="number"
              [(ngModel)]="selectedCategoryItem.displayOrder"
              name="displayOrder"
              placeholder="0"
              min="0"
            />
            <small class="form-hint">Lower numbers appear first</small>
          </div>
          @if (categoryModalMode() === 'edit') {
            <div class="form-group">
              <label for="categoryStatus">Status</label>
              <select
                id="categoryStatus"
                [(ngModel)]="selectedCategoryItem.isActive"
                name="categoryStatus"
              >
                <option [ngValue]="true">Active</option>
                <option [ngValue]="false">Inactive</option>
              </select>
            </div>
          }
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeCategoryFormModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveCategory()">
        {{ categoryModalMode() === 'create' ? 'Add Category' : 'Save Changes' }}
      </app-button>
    </div>
    </div>
  </div>
}
