<div class="products-container">
  <!-- Quick Actions -->
  <div class="quick-actions-bar">
    <button class="quick-action-btn primary" (click)="openCreateModal()">
      <span class="action-icon">‚ûï</span>
      <span>Add New Product</span>
    </button>
    <button class="quick-action-btn secondary" (click)="openCategoryModal()">
      <span class="action-icon">üìÅ</span>
      <span>Manage Categories</span>
    </button>
    <button class="quick-action-btn secondary" (click)="refreshData()">
      <span class="action-icon">üîÑ</span>
      <span>Refresh</span>
    </button>
  </div>

  <app-card>
    <!-- Header -->
    <div header class="products-header">
      <div>
        <h2>Products Management</h2>
        <p class="subtitle">Manage product catalog and inventory</p>
      </div>
      <div class="header-actions">
        <button class="view-toggle" (click)="toggleViewMode()">
          {{ viewMode() === 'grid' ? 'üìã Table View' : 'üî≤ Grid View' }}
        </button>
        <app-button (clicked)="openCreateModal()">
          ‚ûï Add Product
        </app-button>
      </div>
    </div>

    <!-- Filters & Search -->
    <div class="filters-section">
      <div class="filter-tabs">
        <button
          class="filter-tab"
          [class.active]="selectedCategory() === 'all'"
          (click)="onCategoryChange('all')">
          All Products
        </button>
        <button
          *ngFor="let category of categories().slice(1)"
          class="filter-tab"
          [class.active]="selectedCategory() === category"
          (click)="onCategoryChange(category)">
          {{ category }}
        </button>
      </div>

      <!-- Status Filter -->
      <div class="status-filter">
        <select 
          class="status-select"
          [ngModel]="selectedStatus()"
          (ngModelChange)="onStatusChange($event)">
          <option value="all">All Status</option>
          <option value="Active">Active Only</option>
          <option value="Inactive">Inactive Only</option>
        </select>
      </div>

      <div class="search-box">
        <input
          type="text"
          placeholder="Search products..."
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event); onSearchChange()"
          class="search-input"
        />
        <span class="search-icon">üîç</span>
      </div>
    </div>

    <!-- Grid View -->
    <div *ngIf="viewMode() === 'grid'" class="products-grid">
      <div class="product-card" *ngFor="let product of filteredProducts()">
        <div class="product-image">
          <img [src]="product.imageUrl" [alt]="product.name" />
          <app-badge 
            [variant]="getStatusVariant(product.status)" 
            class="status-badge"
          >
            {{ product.status }}
          </app-badge>
        </div>
        <div class="product-info">
          <span class="product-category">{{ product.category }}</span>
          <h3 class="product-name">{{ product.name }}</h3>
          <p class="product-description">{{ product.description }}</p>
          <div class="product-footer">
            <div class="product-price">
              <span class="points-label">Points:</span>
              <span class="points-value">{{ product.pointsPrice }}</span>
            </div>
            <div class="product-stock">
              <app-badge [variant]="getStockStatus(product.stock).variant" size="sm">
                {{ getStockStatus(product.stock).label }}
              </app-badge>
              <span class="stock-count">{{ product.stock }} units</span>
            </div>
          </div>
          <div class="product-actions">
            <app-button size="sm" variant="secondary" (clicked)="openEditModal(product)">
              ‚úèÔ∏è Edit
            </app-button>
            <button class="delete-icon-btn" (click)="deleteProduct(product.id)" title="Delete">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <div *ngIf="viewMode() === 'table'" class="table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Category</th>
            <th>Points Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of filteredProducts()">
            <td>
              <div class="table-product">
                <img [src]="product.imageUrl" [alt]="product.name" class="table-product-image" />
                <div>
                  <strong>{{ product.name }}</strong>
                  <span class="table-description">{{ product.description }}</span>
                </div>
              </div>
            </td>
            <td>{{ product.category }}</td>
            <td>
              <span class="points-value">{{ product.pointsPrice }} pts</span>
            </td>
            <td>
              <div class="stock-info">
                <app-badge [variant]="getStockStatus(product.stock).variant" size="sm">
                  {{ product.stock }} units
                </app-badge>
              </div>
            </td>
            <td>
              <app-badge [variant]="getStatusVariant(product.status)">
                {{ product.status }}
              </app-badge>
            </td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit-btn" (click)="openEditModal(product)" title="Edit">
                  ‚úèÔ∏è
                </button>
                <button class="action-btn delete-btn" (click)="deleteProduct(product.id)" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </app-card>
</div>

<!-- Product Modal -->
<div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalMode() === 'create' ? 'Add New Product' : 'Edit Product' }}</h3>
      <button class="close-btn" (click)="closeModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        <div class="error-list" *ngIf="modalValidationErrors.length > 0">
          <div class="error" *ngFor="let error of modalValidationErrors">{{ error }}</div>
        </div>
        
        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input
            id="productName"
            type="text"
            [(ngModel)]="selectedProduct.name"
            name="name"
            placeholder="Enter product name"
            required
            minlength="2"
            maxlength="200"
          />
          <small class="form-hint">2-200 characters required</small>
        </div>
        <div class="form-group">
          <label for="productDescription">Description</label>
          <textarea
            id="productDescription"
            [(ngModel)]="selectedProduct.description"
            name="description"
            placeholder="Enter product description"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-hint">Max 1000 characters</small>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select
              id="category"
              [(ngModel)]="selectedProduct.categoryId"
              name="categoryId"
              required
            >
              <option value="">Select a category</option>
              <option *ngFor="let cat of dbCategories()" [value]="cat.id">{{ cat.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="pointsPrice">Points Price *</label>
            <input
              id="pointsPrice"
              type="number"
              [(ngModel)]="selectedProduct.pointsPrice"
              name="pointsPrice"
              placeholder="0"
              required
              min="1"
            />
            <small class="form-hint">Must be greater than 0</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="stock">Stock Quantity *</label>
            <input
              id="stock"
              type="number"
              [(ngModel)]="selectedProduct.stock"
              name="stock"
              placeholder="0"
              required
              min="0"
            />
            <small class="form-hint">Cannot be negative</small>
          </div>
          <div class="form-group">
            <label for="status">Status *</label>
            <select
              id="status"
              [(ngModel)]="selectedProduct.status"
              name="status"
              required
            >
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="imageUrl">Image URL</label>
          <input
            id="imageUrl"
            type="url"
            [(ngModel)]="selectedProduct.imageUrl"
            name="imageUrl"
            placeholder="https://example.com/image.jpg"
            maxlength="500"
          />
          <small class="form-hint">Must be a valid URL (http:// or https://), max 500 characters</small>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveProduct()">
        {{ modalMode() === 'create' ? 'Add Product' : 'Save Changes' }}
      </app-button>
    </div>
  </div>
</div>

<!-- Category Management Modal -->
<div class="modal-overlay" *ngIf="showCategoryModal()" (click)="closeCategoryModal()">
  <div class="modal-content category-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìÅ Manage Categories</h3>
      <button class="close-btn" (click)="closeCategoryModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="category-actions">
        <app-button (clicked)="openCreateCategoryForm()">
          ‚ûï Add Category
        </app-button>
      </div>

      <div class="categories-list" *ngIf="allCategories().length > 0">
        <table class="categories-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Order</th>
              <th>Products</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let category of allCategories()" [class.inactive-row]="!category.isActive">
              <td>
                <strong>{{ category.name }}</strong>
              </td>
              <td class="description-cell">{{ category.description || '-' }}</td>
              <td>{{ category.displayOrder }}</td>
              <td>
                <app-badge [variant]="category.productCount > 0 ? 'info' : 'secondary'" size="sm">
                  {{ category.productCount }}
                </app-badge>
              </td>
              <td>
                <app-badge [variant]="category.isActive ? 'success' : 'secondary'" size="sm">
                  {{ category.isActive ? 'Active' : 'Inactive' }}
                </app-badge>
              </td>
              <td>
                <div class="category-action-buttons">
                  <button class="action-btn edit-btn" (click)="openEditCategoryForm(category)" title="Edit">
                    ‚úèÔ∏è
                  </button>
                  <button 
                    class="action-btn toggle-btn" 
                    (click)="toggleCategoryStatus(category)" 
                    [title]="category.isActive ? 'Deactivate' : 'Activate'">
                    {{ category.isActive ? 'üö´' : '‚úÖ' }}
                  </button>
                  <button 
                    class="action-btn delete-btn" 
                    (click)="deleteCategory(category)" 
                    title="Delete"
                    [disabled]="category.productCount > 0">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="empty-categories" *ngIf="allCategories().length === 0">
        <p>No categories found. Click "Add Category" to create one.</p>
      </div>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeCategoryModal()">
        Close
      </app-button>
    </div>
  </div>
</div>

<!-- Category Form Modal (Add/Edit) -->
<div class="modal-overlay" *ngIf="showCategoryFormModal()" (click)="closeCategoryFormModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ categoryModalMode() === 'create' ? '‚ûï Add New Category' : '‚úèÔ∏è Edit Category' }}</h3>
      <button class="close-btn" (click)="closeCategoryFormModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <form>
        <!-- Validation Errors -->
        <div class="error-list" *ngIf="categoryValidationErrors.length > 0">
          <div class="error" *ngFor="let error of categoryValidationErrors">{{ error }}</div>
        </div>
        
        <div class="form-group">
          <label for="categoryName">Category Name *</label>
          <input
            id="categoryName"
            type="text"
            [(ngModel)]="selectedCategoryItem.name"
            name="categoryName"
            placeholder="Enter category name"
            required
            minlength="2"
            maxlength="100"
          />
          <small class="form-hint">2-100 characters required</small>
        </div>

        <div class="form-group">
          <label for="categoryDescription">Description</label>
          <textarea
            id="categoryDescription"
            [(ngModel)]="selectedCategoryItem.description"
            name="categoryDescription"
            placeholder="Enter category description (optional)"
            rows="3"
            maxlength="500"
          ></textarea>
          <small class="form-hint">Max 500 characters</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="displayOrder">Display Order</label>
            <input
              id="displayOrder"
              type="number"
              [(ngModel)]="selectedCategoryItem.displayOrder"
              name="displayOrder"
              placeholder="0"
              min="0"
            />
            <small class="form-hint">Lower numbers appear first</small>
          </div>
          <div class="form-group" *ngIf="categoryModalMode() === 'edit'">
            <label for="categoryStatus">Status</label>
            <select
              id="categoryStatus"
              [(ngModel)]="selectedCategoryItem.isActive"
              name="categoryStatus"
            >
              <option [ngValue]="true">Active</option>
              <option [ngValue]="false">Inactive</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <app-button variant="secondary" (clicked)="closeCategoryFormModal()">
        Cancel
      </app-button>
      <app-button (clicked)="saveCategory()">
        {{ categoryModalMode() === 'create' ? 'Add Category' : 'Save Changes' }}
      </app-button>
    </div>
  </div>
</div>
